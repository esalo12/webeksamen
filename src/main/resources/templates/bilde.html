<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <!-- ... -->
    <meta id="token" name="_csrf" th:content="${_csrf.token}"/>
    <meta id="headerName" name="_csrf_header" th:content="${_csrf.headerName}"/>
    <!-- ... -->
    <title>Bilde</title>
    <script src="exif.js">           </script>
    <script>
        /*<![CDATA[*/
        window.onload=getExif;

        function getExif() {
            var bilde = document.getElementById("bilde");
            EXIF.getData(bilde, function() {
                var kam = document.getElementById("kamera");
                var opplosn = document.getElementById("opplosning");
                var farge = document.getElementById("farge");
                var iso = document.getElementById("iso");
                var bits = document.getElementById("bits");
                var dato = document.getElementById("tatt");

                var kamera = EXIF.getTag(this, "Model");
                var bredde = EXIF.getTag(this, "PixelXDimension");
                var hoyde = EXIF.getTag(this, "PixelYDimension");
                var isoen = EXIF.getTag(this, "ISOSpeedRatings");
                var tid = EXIF.getTag(this, "DateTimeOriginal");

                kam.innerHTML ="Kamera: "+kamera;
                opplosn.innerHTML = "Oppløsning: "+bredde+"x"+hoyde;
                iso.innerHTML = "ISO: "+isoen;
                dato.innerHTML= "Tatt: "+tid;
            });
        }

        function lagreKommentar(id) {
            var token = document.getElementById("token").getAttribute("content");
            var headerName = document.getElementById("headerName").getAttribute("content");
            var nynavn = document.getElementById("navn");
            var nykommentar = document.getElementById("kommentar");
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    nynavn.value="";
                    nykommentar.value="";
                    json = JSON.parse(xmlHttp.responseText);
                    console.log(JSON.stringify(json));
                    var div = document.getElementById("kommentarer");
                    var linje = document.createElement("text");
                    var nydiv = document.createElement("div");
                    var tid = document.createElement("p");
                    var navn = document.createElement("p");
                    var kommentar = document.createElement("p");
                    linje.innerHTML = "____________________________________";
                    tid.innerHTML = Date(json.tid);
                    navn.innerHTML = json.navn;
                    kommentar.innerHTML = json.kommentar;
                    nydiv.appendChild(linje);
                    nydiv.appendChild(tid);
                    nydiv.appendChild(navn);
                    nydiv.appendChild(kommentar);
                    div.appendChild(nydiv);
                }
            };
            xmlHttp.open("POST", "/kommentar", true);
            xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xmlHttp.setRequestHeader(headerName, token);
            xmlHttp.send("id=" + id + "&navn=" + nynavn.value + "&kommentar=" + nykommentar.value);
        }
        /*]]>*/
    </script>
</head>
<body>
    <h1 th:text="${bilde.tittel}"></h1>
    <br />
    <img style="max-width: 1000px" th:src="@{/files/}+${bilde.filnavn}" id="bilde" />
    <div><span id="kamera"></span> </div>
    <div><span id="opplosning"></span></div>
    <div><span id="iso"></span></div>
    <div><span id="tatt"></span></div>
    <div >Størrelse: <span id="storrels" th:text="${bilde.storrelse}+kb"></span> </div>
    <div>Lastet opp: <span id="opplast" th:text="${bilde.dato}" ></span></div>
    <text>____________________________________</text>
    <form>
        <div><label> Navn: <br/><input type="text" id="navn" /></label></div>
        <div><label> Skriv inn kommentar: <br /><textarea id="kommentar"></textarea></label></div>
        <input th:id="${bilde.id}" type="button" value="Lagre" onclick="lagreKommentar(this.id)" />
    </form>
<div id="kommentarer" >
    <div th:each="k : ${bilde.kommentarer}" >
        <text>____________________________________</text>
        <p th:text="${k.dato}"></p>
        <p th:text="${k.navn}+': '"></p>
        <p th:text="${k.kommentar}"></p>
    </div>
</div>


</body>
</html>